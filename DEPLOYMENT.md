# Production Deployment Guide

## Docker/Nixpacks Deployment

This application is configured for deployment using Gunicorn WSGI server within a Docker container generated by nixpacks.

### Quick Start

#### Option 1: Automated Deployment (Recommended)

**Linux/macOS:**
```bash
# Make script executable
chmod +x deploy.sh

# Run deployment script
./deploy.sh
```

**Windows:**
```cmd
# Run deployment script
deploy.bat
```

**Quick Deploy (uses defaults):**
```bash
# For rapid testing with default credentials
chmod +x quick-deploy.sh
./quick-deploy.sh
```

#### Option 2: Manual Deployment

1. **Environment Variables**: Set these required environment variables:
   ```bash
   SECRET_KEY=your-strong-32-char-secret-key
   ADMIN_EMAIL=admin@yourcompany.com
   ADMIN_PASSWORD=your-strong-admin-password
   API_KEY=your-secure-api-key
   PORT=5000
   ```

2. **Deploy**: The application will automatically:
   - Install dependencies from `requirements.txt`
   - Initialize the SQLite database
   - Start with Gunicorn WSGI server
   - Listen on `0.0.0.0:$PORT`

### Security Considerations

#### Environment Variables
Generate secure values for production:

```bash
# Generate SECRET_KEY
python -c "import secrets; print(secrets.token_hex(32))"

# Generate API_KEY  
python -c "import secrets; print('timesheet-api-' + secrets.token_urlsafe(32))"
```

#### Required Environment Variables
```bash
SECRET_KEY=                    # 32+ character random string
ADMIN_EMAIL=                   # Admin user email
ADMIN_PASSWORD=                # Strong admin password
API_KEY=                       # Secure API key for Power BI
DATABASE=timesheet.db          # Database file path
```

#### Optional Environment Variables
```bash
FLASK_ENV=production          # Set to production
FLASK_DEBUG=false            # Disable debug mode
PORT=5000                    # Port number (default: 5000)
```

### File Structure

```
Guerrilla-T/
├── wsgi.py                  # WSGI entry point for Gunicorn
├── run.py                   # Development entry point
├── deploy.sh                # Linux/macOS deployment script
├── deploy.bat               # Windows deployment script  
├── quick-deploy.sh          # Quick deployment with defaults
├── Procfile                 # Process definition for deployment
├── nixpacks.toml           # Nixpacks configuration
├── requirements.txt         # Python dependencies (includes gunicorn)
├── .env.production         # Production environment template
├── app/                    # Application package
└── static/                 # Static assets
```

### Deployment Process

#### Automated Scripts

The deployment scripts handle the entire process:

1. **Prerequisites Check**:
   - Verify nixpacks installation
   - Verify Docker is running
   - Generate secure secrets automatically

2. **Configuration**:
   - Prompt for admin credentials
   - Generate strong SECRET_KEY and API_KEY
   - Configure environment variables

3. **Build & Deploy**:
   - Build Docker image with nixpacks
   - Create data directory for database persistence
   - Stop/remove any existing containers
   - Start new container with proper configuration

#### Manual Process

1. **Nixpacks Build Phase**:
   - Detects Python application
   - Installs dependencies from `requirements.txt`
   - Initializes SQLite database

2. **Runtime Phase**:
   - Starts Gunicorn with 2 workers
   - Binds to `0.0.0.0:$PORT`
   - Serves WSGI application

### Health Checks

The application includes a health check endpoint:
- **URL**: `/health`
- **Response**: JSON with status and timestamp
- **Use**: Container orchestration health checks

### Database Persistence

- **SQLite Database**: `timesheet.db` file
- **Location**: Application root directory
- **Backup**: Ensure database file is included in persistent storage
- **Initialization**: Automatic on first run

### Gunicorn Configuration

Default configuration (from `Procfile`):
```bash
gunicorn wsgi:application --bind 0.0.0.0:$PORT --workers 2 --timeout 60 --keep-alive 2
```

#### Configuration Options:
- **Workers**: 2 (adjust based on CPU cores)
- **Timeout**: 60 seconds
- **Keep-alive**: 2 seconds
- **Binding**: All interfaces on specified port

### Monitoring & Logging

- **Application Logs**: Sent to stdout (captured by container)
- **Health Endpoint**: `/health` for monitoring
- **Log Level**: INFO in production
- **Format**: Timestamped with log level and message

### Production Checklist

- [ ] Set strong `SECRET_KEY`
- [ ] Set secure `API_KEY` 
- [ ] Use strong admin password
- [ ] Configure proper domain/SSL
- [ ] Set up database backups
- [ ] Configure monitoring/alerts
- [ ] Test health check endpoint
- [ ] Verify environment variables
- [ ] Test OAuth configuration (if used)
- [ ] Validate 2FA functionality

### Scaling Considerations

- **Database**: SQLite works well for small-medium teams
- **Workers**: Scale Gunicorn workers based on CPU cores
- **Static Files**: Consider CDN for larger deployments
- **Session Storage**: Flask-Login sessions stored server-side

### Troubleshooting

#### Common Issues:

1. **Database Permissions**: Ensure container can write to database location
2. **Port Binding**: Verify `PORT` environment variable is set
3. **Environment Variables**: Check all required vars are configured
4. **Static Files**: Ensure static directory is accessible

#### Debug Mode:
```bash
FLASK_DEBUG=true  # Enable only for debugging
```

#### Logs:
```bash
# View container logs
docker logs <container-id>

# Health check
curl http://localhost:5000/health
```

### Security Notes

- Debug mode is disabled in production
- Passwords hashed with bcrypt
- API endpoints require Bearer token authentication
- SQL injection protection via parameterized queries
- CSRF protection in OAuth flows
- Session management via Flask-Login
